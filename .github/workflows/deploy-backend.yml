name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'ndvi-calculatorr/server/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY: ndvi-backend

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get short commit SHA
        id: commit
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        working-directory: ./ndvi-calculatorr/server
        run: |
          docker build -t ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.commit.outputs.sha }} .
          docker tag ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.commit.outputs.sha }} \
                     ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

      - name: Push Docker image to ECR
        run: |
          docker push ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.commit.outputs.sha }}
          docker push ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

  deploy:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "üîê Login to ECR"
            aws ecr get-login-password --region eu-central-1 | \
              docker login -u AWS --password-stdin 725948481931.dkr.ecr.eu-central-1.amazonaws.com

            echo "üì• Pull image"
            docker pull 725948481931.dkr.ecr.eu-central-1.amazonaws.com/ndvi-backend:latest

            echo "üõë Stop old container"
            docker stop ndvi-backend || true
            docker rm ndvi-backend || true

            echo "üîë Fetch DB password from AWS-managed RDS secret"
            export DB_PASSWORD=$(aws secretsmanager get-secret-value \
              --secret-id arn:aws:secretsmanager:eu-central-1:725948481931:secret:rds!db-4d21cf3e-dfd4-4974-a12e-0f387bc4d618-OknCOA \
              --region eu-central-1 \
              --query SecretString \
              --output text | jq -r '.password')

            echo "üîë Fetch JWT secret"
            export JWT_SECRET=$(aws secretsmanager get-secret-value \
              --secret-id ndvi/jwt/secret \
              --region eu-central-1 \
              --query SecretString \
              --output text)

            echo "üîë Fetch GEE credentials"
            export GEE_CREDENTIALS=$(aws secretsmanager get-secret-value \
              --secret-id ndvi/gee/credentials \
              --region eu-central-1 \
              --query SecretString \
              --output text)

            export GEE_PRIVATE_KEY=$(echo "$GEE_CREDENTIALS" | jq -r '.private_key')
            export GEE_CLIENT_EMAIL=$(echo "$GEE_CREDENTIALS" | jq -r '.client_email')
            export GEE_PROJECT_ID=$(echo "$GEE_CREDENTIALS" | jq -r '.project_id')

            echo "üöÄ Start new container"
            docker run -d \
              --name ndvi-backend \
              --restart always \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e AWS_REGION=eu-central-1 \
              -e DB_HOST=${{ secrets.RDS_HOST }} \
              -e DB_PORT=5432 \
              -e DB_NAME=ndvi_majmaah_db \
              -e DB_USER=postgres \
              -e DB_PASSWORD="$DB_PASSWORD" \
              -e JWT_SECRET="$JWT_SECRET" \
              -e GEE_PRIVATE_KEY="$GEE_PRIVATE_KEY" \
              -e GEE_CLIENT_EMAIL="$GEE_CLIENT_EMAIL" \
              -e GEE_PROJECT_ID="$GEE_PROJECT_ID" \
              -e PORT=3000 \
              725948481931.dkr.ecr.eu-central-1.amazonaws.com/ndvi-backend:latest

            echo "‚è≥ Waiting for health check"
            sleep 10

            for i in {1..30}; do
              if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "‚úÖ Health check passed!"
                exit 0
              fi
              echo "Health check $i/30..."
              sleep 2
            done

            echo "‚ùå Health check failed"
            docker logs ndvi-backend --tail 50
            exit 1
