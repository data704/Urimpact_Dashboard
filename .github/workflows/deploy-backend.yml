name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'ndvi-calculatorr/server/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY: ndvi-backend

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get short commit SHA
        id: commit
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        working-directory: ./ndvi-calculatorr/server
        run: |
          docker build -t 725948481931.dkr.ecr.eu-central-1.amazonaws.com/ndvi-backend:${{ steps.commit.outputs.sha }} .
          docker tag 725948481931.dkr.ecr.eu-central-1.amazonaws.com/ndvi-backend:${{ steps.commit.outputs.sha }} \
                     725948481931.dkr.ecr.eu-central-1.amazonaws.com/ndvi-backend:latest

      - name: Push Docker image to ECR
        run: |
          docker push 725948481931.dkr.ecr.eu-central-1.amazonaws.com/ndvi-backend:${{ steps.commit.outputs.sha }}
          docker push 725948481931.dkr.ecr.eu-central-1.amazonaws.com/ndvi-backend:latest

  deploy:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "üîê Login to ECR"
            aws ecr get-login-password --region eu-central-1 | \
              docker login -u AWS --password-stdin 725948481931.dkr.ecr.eu-central-1.amazonaws.com

            echo "üì• Pull image"
            docker pull 725948481931.dkr.ecr.eu-central-1.amazonaws.com/ndvi-backend:latest

            echo "üõë Stop old container"
            docker stop ndvi-backend || true
            docker rm ndvi-backend || true

            echo "üîë Fetch DB password from AWS-managed RDS secret"
            export DB_PASSWORD=$(aws secretsmanager get-secret-value \
              --secret-id 'arn:aws:secretsmanager:eu-central-1:725948481931:secret:rds!db-4d21cf3e-dfd4-4974-a12e-0f387bc4d618-OknCOA' \
              --region eu-central-1 \
              --query SecretString \
              --output text | jq -r '.password')

            echo "üîë Fetch JWT secret"
            export JWT_SECRET=$(aws secretsmanager get-secret-value \
              --secret-id ndvi/jwt/secret \
              --region eu-central-1 \
              --query SecretString \
              --output text)

            echo "üîë Fetch GEE credentials"
            export GEE_PROJECT_ID="generated-motif-436602-f7"
            export GEE_CLIENT_EMAIL="climafund-c1e611ae590cbb41273c@generated-motif-436602-f7.iam.gserviceaccount.com"
            
            # CRITICAL FIX: Store private key preserving newlines
            cat > /tmp/gee_key.pem << 'EOF'
            -----BEGIN PRIVATE KEY-----
            MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC0FuF9WkvYStHl
            B3eJN2fq/5DcyZJGLShy6fdA0Uy2BXHgSDv5IWBuaZC9b8uE7keEi2OEmwCB3AnC
            IRIJebxoht1LFvRTtEL/+88iu/Bn95QmDHJJDxwPanQWrW5F3VDkzv1CDbvjaIj0
            rC/08SnfXHTDgQqIFW0xGyO3RwxAqp1T9P9Je3HKzf+VAdrsk5erU5u/mr/J6JjU
            WWZo8SsawBcvgEsGuero0YasjaFeu4nQp0MNT9DZjH7H8RhwzzDAXdx3gKgiBQ2A
            Zf+8wVNA145q0myCqhiMJSkPDzxQpkQ4Rys5/xXht1Nr6/FwW++fnUwoTRLlYVQy
            HIHj9OBPAgMBAAECggEAFAtp7Lhksb3eL+ZNXUX/+I2ak6CR+eKj2mqFPT8ukSH5
            A1Q27KtU3uU8GYG8ft7AshWLraJNA6c4pNVmewyENoQwVF/JMRnizTg7XWvavc+2
            OyfufohCgMrCAhYqrHcOPnF1iekabRzhBY62xcYj+XsCehI+WFg+L5WMO6WaTQYg
            hwTcsO5jJ1sL/XepNfI93hSGnccyClBNAOv4foh/bSJ07gW9SWe5+JEBeERzB1YL
            sCoiGMDlgcxIKQKN3o6eb88gPlunXItLmV6ZYQa4nfK3xKurUQHnG2b2H5+Fr31c
            2EPeAbPNmgZauAt12dSZUYk6A2su27hyucOiTffZpQKBgQDpXxILortSJK2SGOkt
            qfydtbQ1lgwY8G6BgTlkw2GcgC7bb/bPmqOev3llLnZVAXWgLhNbQvj3akk6wk1d
            zqY1chbtAdVvqmqgj60mdEqM5NBpS3Zv+BrDDKaK44vG0UbOSMf3b9BNVbod2tpG
            VYogLXzb97K7vhGAGEet4vJ51QKBgQDFjTPSFx8oYQkGVxndIDdHcBKXX0/NmBDH
            EoQinkdiv33FX6tWf00VxYj7UTUZ3snQ671Kbb3TiCcIhp+cD9UI6Fd2l99YrWpy
            HG0EdoXF3LoRphLL5LqIJZi1xLKiHs63qfLmmJUuAyfOUiexsUF6KQ62rEVCttJi
            MV4QgQe/kwKBgBbZsTmkcHUFlF02xTYsa8jBbujETWDvwdI6ZfVA0EDzqCLiXqdL
            O/QiSW+n0fxWzT6m5ExOTXRkWtE/DzY9MrcO+cGxKUXqyM/54Xlfb6FGEkYNFoa2
            I2Cvz2rQBvKrsSQnqjTHJP09hKDBuhei7ohiC9S59y082hfRyMr06ssVAoGBAKOb
            YYNo6sECO/soP59GgwGC66K5qNnYSmzUBOK2uuApPvwrUzb7jtetFNkuVA/s1q9T
            zRzK7h817z28YItbAU+zPFxXQv2qATIoIJFFp1xKhT8AjyiVcXY3zNUc5eQmJ4Us
            FqKrU0EcE+dnWsBq0JNfVXQsD+BEkNAJmqGIeuZJAoGAUOfavlpsMf/JKRg7/cHF
            eiqoSUFu5PkMMMJOHVoet4E5LNqtkBQzF0vuVLPLF77lWCsdlMtPvG+dKB9z9AJm
            6IKh41h1Y6UPvXSyA/rNfGnfVO3OEXwWqoSF84W4CWgIFltIOJki1+lB+xOAINaH
            1xcM65zVf2UtG307unI7PhQ=
            -----END PRIVATE KEY-----
            EOF
            
            # Convert to single line with \n for Docker env var
            export GEE_PRIVATE_KEY=$(awk 'NF {sub(/\r/, ""); printf "%s\\n",$0;}' /tmp/gee_key.pem)
            rm /tmp/gee_key.pem

            echo "üöÄ Start new container"
            docker run -d \
              --name ndvi-backend \
              --restart always \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e AWS_REGION=eu-central-1 \
              -e DB_HOST=ndvi-majmaah-db.c9quck2ekoks.eu-central-1.rds.amazonaws.com \
              -e DB_PORT=5432 \
              -e DB_NAME=ndvi_majmaah_db \
              -e DB_USER=postgres \
              -e DB_PASSWORD="$DB_PASSWORD" \
              -e JWT_SECRET="$JWT_SECRET" \
              -e GEE_PROJECT_ID="$GEE_PROJECT_ID" \
              -e GEE_CLIENT_EMAIL="$GEE_CLIENT_EMAIL" \
              -e GEE_PRIVATE_KEY="$GEE_PRIVATE_KEY" \
              -e CORS_ORIGINS="${{ secrets.CORS_ORIGINS }}" \
              -e PORT=3000 \
              725948481931.dkr.ecr.eu-central-1.amazonaws.com/ndvi-backend:latest

            echo "‚è≥ Waiting for health check"
            sleep 10

            for i in {1..30}; do
              if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "‚úÖ Health check passed!"
                exit 0
              fi
              echo "Health check $i/30..."
              sleep 2
            done

            echo "‚ùå Health check failed"
            docker logs ndvi-backend --tail 50
            exit 1